# =============================================================================
# Factorio Server - Docker Compose Configuration
# =============================================================================
# 
# Usage:
#   1. Copy .env.example to .env and configure
#   2. Generate map previews: docker compose --profile gen-map run gen-map
#   3. Create world: docker compose --profile create-world run create-world
#   4. Start server: docker compose up -d factorio
#   5. Backups run automatically via borgmatic
#
# =============================================================================

services:
  # ===========================================================================
  # Factorio Game Server
  # ===========================================================================
  factorio:
    image: ${FACTORIO_IMAGE:-factoriotools/factorio:stable}
    container_name: factorio-server
    restart: unless-stopped
    ports:
      - "${PORT:-34197}:34197/udp"
      - "${RCON_PORT:-27015}:27015/tcp"
    environment:
      - SAVE_NAME=${SAVE_NAME:-world}
      - GENERATE_NEW_SAVE=${GENERATE_NEW_SAVE:-true}
      - LOAD_LATEST_SAVE=${LOAD_LATEST_SAVE:-true}
      - UPDATE_MODS_ON_START=${UPDATE_MODS_ON_START:-true}
      - USERNAME=${USERNAME:-}
      - TOKEN=${TOKEN:-}
      - UPDATE_IGNORE=${UPDATE_IGNORE:-}
    volumes:
      - ./data/saves:/factorio/saves
      - ./data/mods:/factorio/mods
      - ./config:/factorio/config
    healthcheck:
      test: ["CMD-SHELL", "pidof factorio || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ===========================================================================
  # Borgmatic Backup Service
  # ===========================================================================
  borgmatic:
    image: ghcr.io/borgmatic-collective/borgmatic:latest
    container_name: borgmatic-factorio
    restart: unless-stopped
    environment:
      - TZ=${TZ:-UTC}
      - BACKUP_NAME=${BACKUP_NAME:-factorio}
      - BACKUP_CRON=${BACKUP_CRON:-0 */6 * * *}
    volumes:
      - ./borgmatic:/etc/borgmatic.d:ro
      - ./backups:/mnt/borg-repository
      - ./data/saves:/mnt/source/saves:ro
      - ./data/mods:/mnt/source/mods:ro
      - ./config:/mnt/source/config:ro
    secrets:
      - borg_passphrase
    entrypoint: ["/etc/borgmatic.d/entrypoint.sh"]

  # ===========================================================================
  # Map Preview Generator (one-shot service)
  # ===========================================================================
  # Usage: docker compose --profile gen-map run gen-map [seed]
  # Or use the helper script: ./scripts/gen-map.sh
  gen-map:
    image: ${FACTORIO_IMAGE:-factoriotools/factorio:stable}
    profiles:
      - gen-map
    environment:
      - MAP_PREVIEW_COUNT=${MAP_PREVIEW_COUNT:-100}
      - MAP_PREVIEW_SCALE=${MAP_PREVIEW_SCALE:-4}
      - MAP_PREVIEW_SIZE=${MAP_PREVIEW_SIZE:-512}
      - MAP_SEED=${MAP_SEED:-}
    volumes:
      - ./data/mods:/factorio/mods:ro
      - ./config:/factorio/config:ro
      - ./output/maps:/output
    working_dir: /output
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "=== Factorio Map Preview Generator ==="
        
        # If a seed is provided as argument, generate single high-detail preview
        if [ -n "$$MAP_SEED" ]; then
          echo "Generating preview for seed: $$MAP_SEED"
          /opt/factorio/bin/x64/factorio \
            --generate-map-preview "/output/seed_$${MAP_SEED}.png" \
            --map-gen-settings /factorio/config/map-gen-settings.json \
            --map-gen-seed "$$MAP_SEED" \
            --map-preview-scale 1 \
            --map-preview-size 4096
        else
          echo "Generating $$MAP_PREVIEW_COUNT random map previews..."
          echo "Scale: $$MAP_PREVIEW_SCALE, Size: $$MAP_PREVIEW_SIZE"
          /opt/factorio/bin/x64/factorio \
            --generate-map-preview "/output/preview.png" \
            --map-gen-settings /factorio/config/map-gen-settings.json \
            --map-preview-count "$$MAP_PREVIEW_COUNT" \
            --map-preview-scale "$$MAP_PREVIEW_SCALE" \
            --map-preview-size "$$MAP_PREVIEW_SIZE"
        fi
        
        echo "=== Map previews generated in /output ==="
        ls -la /output/*.png 2>/dev/null || echo "No PNG files found"

  # ===========================================================================
  # World Creator (one-shot service)
  # ===========================================================================
  # Usage: docker compose --profile create-world run create-world
  # Creates a new world save with the configured seed and settings
  create-world:
    image: ${FACTORIO_IMAGE:-factoriotools/factorio:stable}
    profiles:
      - create-world
    environment:
      - SAVE_NAME=${SAVE_NAME:-world}
      - MAP_SEED=${MAP_SEED:-}
    volumes:
      - ./data/saves:/factorio/saves
      - ./data/mods:/factorio/mods:ro
      - ./config:/factorio/config:ro
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        echo "=== Factorio World Creator ==="
        SAVE_FILE="/factorio/saves/$${SAVE_NAME}.zip"
        
        if [ -f "$$SAVE_FILE" ]; then
          echo "WARNING: Save file already exists at $$SAVE_FILE"
          echo "Delete or rename it first if you want to create a new world."
          exit 1
        fi
        
        # Build the create command with optional seed
        CMD="/opt/factorio/bin/x64/factorio --create $$SAVE_FILE"
        CMD="$$CMD --map-gen-settings /factorio/config/map-gen-settings.json"
        CMD="$$CMD --map-settings /factorio/config/map-settings.json"
        
        if [ -n "$$MAP_SEED" ]; then
          echo "Using seed: $$MAP_SEED"
          CMD="$$CMD --map-gen-seed $$MAP_SEED"
        else
          echo "Using random seed"
        fi
        
        echo "Creating world: $$SAVE_FILE"
        eval "$$CMD"
        
        echo "=== World created successfully ==="
        ls -la /factorio/saves/

# =============================================================================
# Secrets Configuration
# =============================================================================
secrets:
  borg_passphrase:
    file: ./.secrets/borg_passphrase
